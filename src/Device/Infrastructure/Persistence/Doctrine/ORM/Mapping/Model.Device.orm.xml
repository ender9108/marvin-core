<?xml version="1.0" encoding="UTF-8"?>
<doctrine-mapping xmlns="http://doctrine-project.org/schemas/orm/doctrine-mapping"
                  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                  xsi:schemaLocation="http://doctrine-project.org/schemas/orm/doctrine-mapping
                          https://www.doctrine-project.org/schemas/orm/doctrine-mapping.xsd">
    <entity
        name="Marvin\Device\Domain\Model\Device"
        repository-class="Marvin\Device\Infrastructure\Persistence\Doctrine\ORM\Repository\DoctrineDeviceRepository"
        table="device_device"
    >
        <id name="id" type="device_id" column="id">
            <generator strategy="NONE"/>
        </id>

        <!-- Common properties -->
        <embedded name="label" class="Marvin\Shared\Domain\ValueObject\Label" />
        <embedded name="description" class="Marvin\Shared\Domain\ValueObject\Description" />
        <embedded name="metadata" class="Marvin\Shared\Domain\ValueObject\Metadata" />

        <!-- Device type and status -->
        <field name="deviceType" nullable="false" length="32" enum-type="Marvin\Device\Domain\ValueObject\DeviceType" />
        <field name="status" nullable="false" length="32" enum-type="Marvin\Device\Domain\ValueObject\DeviceStatus" />

        <!-- Physical device properties -->
        <field name="protocol" nullable="true" length="32" enum-type="Marvin\Device\Domain\ValueObject\Protocol" />
        <field name="protocolId" type="protocol_id" nullable="true" />
        <embedded name="physicalAddress" class="Marvin\Device\Domain\ValueObject\PhysicalAddress" />
        <embedded name="technicalName" class="Marvin\Device\Domain\ValueObject\TechnicalName" />

        <!-- Composite device properties -->
        <field name="compositeType" length="16" nullable="true" enum-type="Marvin\Device\Domain\ValueObject\CompositeType" />
        <field name="compositeStrategy" length="32" nullable="true" enum-type="Marvin\Device\Domain\ValueObject\CompositeStrategy" />
        <field name="executionStrategy" length="32" nullable="true" enum-type="Marvin\Device\Domain\ValueObject\ExecutionStrategy" />
        <field name="childDeviceIds" type="json" nullable="true" />
        <embedded name="nativeGroupInfo" class="Marvin\Device\Domain\ValueObject\NativeGroupInfo" />
        <field name="nativeSubGroups" type="json" nullable="true" />
        <embedded name="nativeSceneInfo" class="Marvin\Device\Domain\ValueObject\NativeSceneInfo" />
        <embedded name="sceneStates" class="Marvin\Device\Domain\ValueObject\SceneStates" />

        <!-- Virtual device properties -->
        <field name="virtualType" nullable="true" enum-type="Marvin\Device\Domain\ValueObject\VirtualDeviceType" />
        <embedded name="virtualConfig" class="Marvin\Device\Domain\ValueObject\VirtualDeviceConfig" />

        <!-- Zone assignment -->
        <field name="zoneId" type="zone_id" nullable="true" />

        <!-- Timestamps -->
        <field name="createdAt" type="datetime" nullable="false" />
        <field name="lastSeenAt" type="datetime" nullable="true" />
        <field name="lastStateUpdateAt" type="datetime" nullable="true" />

        <!-- Capabilities relationship -->
        <one-to-many
            field="capabilities"
            target-entity="Marvin\Device\Domain\Model\DeviceCapability"
            orphan-removal="true"
            mapped-by="device"
        >
            <cascade>
                <cascade-persist />
                <cascade-remove />
            </cascade>
        </one-to-many>

        <!-- Indexes for common queries -->
        <indexes>
            <index name="idx_device_type" columns="device_type" />
            <index name="idx_device_status" columns="status" />
            <index name="idx_device_protocol" columns="protocol" />
            <index name="idx_device_protocol_id" columns="protocol_id" />
            <index name="idx_device_zone_id" columns="zone_id" />
            <index name="idx_device_composite_type" columns="composite_type" />
            <index name="idx_device_created_at" columns="created_at" />
        </indexes>
    </entity>
</doctrine-mapping>
